@model IEnumerable<IChat.Models.user_master>
@{
    ViewBag.Title = "Index";
}


@section css{
    <style>
        .portlet {
            margin-bottom: 15px;
        }

        .btn-white {
            border-color: #cccccc;
            color: #333333;
            background-color: #ffffff;
        }

        .portlet {
            border: 1px solid;
        }

            .portlet .portlet-heading {
                padding: 0 15px;
            }

                .portlet .portlet-heading h4 {
                    padding: 1px 0;
                    font-size: 16px;
                }

                .portlet .portlet-heading a {
                    color: #fff;
                }

                    .portlet .portlet-heading a:hover,
                    .portlet .portlet-heading a:active,
                    .portlet .portlet-heading a:focus {
                        outline: none;
                    }

            .portlet .portlet-widgets .dropdown-menu a {
                color: #333;
            }

            .portlet .portlet-widgets ul.dropdown-menu {
                min-width: 0;
            }

            .portlet .portlet-heading .portlet-title {
                float: left;
            }

                .portlet .portlet-heading .portlet-title h4 {
                    margin: 10px 0;
                }

            .portlet .portlet-heading .portlet-widgets {
                float: right;
                margin: 8px 0;
            }

                .portlet .portlet-heading .portlet-widgets .tabbed-portlets {
                    display: inline;
                }

                .portlet .portlet-heading .portlet-widgets .divider {
                    margin: 0 5px;
                }

            .portlet .portlet-body {
                padding: 15px;
                background: #fff;
            }

            .portlet .portlet-footer {
                padding: 10px 15px;
                background: #e0e7e8;
            }

                .portlet .portlet-footer ul {
                    margin: 0;
                }

        .portlet-green,
        .portlet-green > .portlet-heading {
            border-color: #16a085;
        }

            .portlet-green > .portlet-heading {
                color: #fff;
                background-color: #16a085;
            }

        .portlet-orange,
        .portlet-orange > .portlet-heading {
            border-color: #f39c12;
        }

            .portlet-orange > .portlet-heading {
                color: #fff;
                background-color: #f39c12;
            }

        .portlet-blue,
        .portlet-blue > .portlet-heading {
            border-color: #2980b9;
        }

            .portlet-blue > .portlet-heading {
                color: #fff;
                background-color: #2980b9;
            }

        .portlet-red,
        .portlet-red > .portlet-heading {
            border-color: #e74c3c;
        }

            .portlet-red > .portlet-heading {
                color: #fff;
                background-color: #e74c3c;
            }

        .portlet-purple,
        .portlet-purple > .portlet-heading {
            border-color: #8e44ad;
        }

            .portlet-purple > .portlet-heading {
                color: #fff;
                background-color: #8e44ad;
            }

        .portlet-default,
        .portlet-dark-blue,
        .portlet-default > .portlet-heading,
        .portlet-dark-blue > .portlet-heading {
            border-color: #34495e;
        }

            .portlet-default > .portlet-heading,
            .portlet-dark-blue > .portlet-heading {
                color: #fff;
                background-color: #34495e;
            }

        .portlet-basic,
        .portlet-basic > .portlet-heading {
            border-color: #333;
        }

            .portlet-basic > .portlet-heading {
                border-bottom: 1px solid #333;
                color: #333;
                background-color: #fff;
            }
    </style>
}


@section js{
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
    var clients = [];
    var chat;
    var userName;
    $(function () {
        // Reference the auto-generated proxy for the hub.
        chat = $.connection.chatHub;
        // Create a function that the hub can call back to display messages.
        var id =@ViewBag.user.id;
        //chat.client.addMessage =function(name,message)
        //{
        //    $('#discussion').append('<li><strong>' + htmlEncode(name)+ '</strong>: ' + htmlEncode(message) + '</li>');
        //};
        var username ="@ViewBag.user.name";
        $('#displayname').val(username);
        // Set initial focus to message input box.
        $('#message').focus();
        //显示提示方法
        chat.client.showMessage = function (message) {
            alert(message);
        }
        //注册显示信息的方法
        chat.client.addMessage = function (message, connectionId,ismyself) {

            debugger
            if ($.inArray(connectionId, clients)==-1) {
                var findbtn_conID="button[connectionId="+connectionId+"]";
                var friendName= $(findbtn_conID).attr('friendName');
                showWin(connectionId,friendName);
            }
            if(ismyself)
            {
                //$('#chat_area').append('<li>'+username+"  "+message+'</li>')
                $("#" + connectionId).find("ul").append('<li>'+username+"  "+message+'</li>')
            }
            else
            {
                var findbtn_conID="button[connectionId="+connectionId+"]";
                var friendName= $(findbtn_conID).attr('friendName');
                $("#" + connectionId).find("ul").append('<li>'+friendName+"  "+message+'</li>')
            }

           // $("#" + connectionId).find("ul").append($(this).append('<li>'+connectionId+"  "+message+'</li>'))
        }
        //注册显示所有用户的方法
        chat.client.getUsers = function (data) {

            if (data) {
                var json = $.parseJSON(data);

                console.info(json);
                $("#users").html(" ");
                for (var i = 0; i < json.length; i++) {
                    var html = '<li>用户名:' + json[i].Name + '<button friendName="'+json[i].Name+'" connectionId="' + json[i].ConnectionID + '" onclick="userChat(this)">聊天</button>';
                    $("#users").append(html);
                }
            }
        }
        //注册显示推出聊天提示的方法
        chat.client.exitUser = function (data)
        {
            alert(data);
        }
        //注册显示个人信息的方法
        chat.client.showId = function (data)
        {
            $("#conId").html(data);
            clients.push(data);
        }

        $.connection.hub.start().done(function () {

            var connId = $.connection.hub.id;
            $('#connId').text(connId);
            chat.server.getName(username);


            $('#sendmessage').click(function () {
                var friendId = $('#friendconnId').val();
                chat.server.sendClient($('#displayname').val(), $('#message').val(), friendId);
                //$('#discussion').append('<li><strong>' +username+ '</strong>: ' + $('#message').val() + '</li>');
                //$('#message').val('').focus();
            });
        });
    });

        //开始聊天
        function userChat(obj)
        {
            var connectionId = $(obj).attr('connectionId');
            var friendName = $(obj).attr('friendName');
            showWin(connectionId,friendName);
        }
        function  showWin(connectionId,friendName)
        {
            //var connectionId = $(obj).attr('connectionId');
            clients.push(connectionId);
            var html = '<div style="float:left;margin-left:30px;border:double" id="' + connectionId + '" connectionId="' + connectionId + '">' + friendName + '的房间聊天记录如下:<button onclick="exitChat(this)">退出</button><ul id=chat_area></ul><input type="text" /> <button onclick="sendMessage(this)">发送</button></div>';
            $("#userBox").append(html);
        }

        function exitChat(btnObj)
        {
            debugger
            //  var connectionId = $(btnObj).parent().attr("connectionId");
            $(btnObj).parent().remove();
            //chat.server.exitChat(connectionId);
        }
        //发送消息
        function sendMessage(data)
        {
            var message = $(data).prev().val();
            var  userObj = $(data).parent();
            var username = $("#userName").html();
            message = username + ":" + message;
            console.info($(userObj).attr("connectionId"));
            var targetConnectionId = $(userObj).attr("connectionId");
            chat.server.sendMessage(targetConnectionId, message);
            $(data).prev().val("");
        }

    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }
   </script>

    }
<h2>聊天室首頁</h2>
<h3>@ViewBag.user.name 你好~</h3>
<div>名称：<p id="userName"></p></div>
<div>ConnectionID:<p id="conId"></p></div>  
<div style="width:25%;border:1px solid #ff0000">
    <div>在线用户列表</div>
    <ul id="users"></ul>
    <div id="userBox"></div> 
</div>  
<h3 id="connId"></h3>
<input type="text" id="friendconnId" />
<input type="text" id="message" />
<input type="button" id="sendmessage" value="Send" />
<input type="hidden" id="displayname" />
<ul id="discussion"></ul>
<div class="container">
    @*<a href="@Url.Action("Index","Home")" class="btn btn-primary"><span class="glyphicon glyphicon-plus"></span></a>*@
    <div class="row">
        <table class="table table-bordered table-hover col-lg-12">
            <thead>
                <tr>
                    <th>個人編號</th>
                    <th>個人名稱</th>
                    <th>個人電話</th>
                    <th>個人email</th>
                    <th>編輯</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@ViewBag.user.id</td>
                    <td>@ViewBag.user.name</td>
                    <td>@ViewBag.user.phone</td>
                    <td>@ViewBag.user.email</td>
                    <td>
                        <a href="@Url.Action("Edit", "Home", new { id = ViewBag.user.id })" class="btn btn-primary"><span class="glyphicon glyphicon-pencil"></span></a>
                    </td>
                    @*<td>
                            <a href="@Url.Action("Index", "Home")" class="btn btn-danger"><span class="glyphicon glyphicon-trash"></span></a>
                        </td>*@
                </tr>
            </tbody>
        </table>
        <h3>在線朋友列表</h3>
        <div class="list-group col-lg-6">
            @*<a href="#" class="list-group-item active">
                    Cras justo odio
                </a>*@
            @foreach (var user in Model)
            {
                if (user.id != ViewBag.user.id && user.IsOnline)
                {
                    <a href="#" class="list-group-item alert alert-success">
                        @user.name
                        <span class="badge">14</span>
                    </a>
                }
            }
        </div>



        <div class="container bootstrap snippet col-lg-6">
            <div class="row">
                <div class="col-lg-12">
                    <div class="portlet portlet-default">
                        <div class="portlet-heading">
                            <div class="portlet-title">
                                <h4><i class="fa fa-circle text-green"></i> Jane Smith</h4>
                            </div>
                            <div class="portlet-widgets">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-white dropdown-toggle btn-xs" data-toggle="dropdown">
                                        <i class="fa fa-circle text-green"></i> Status
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li>
                                            <a href="#"><i class="fa fa-circle text-green"></i> Online</a>
                                        </li>
                                        <li>
                                            <a href="#"><i class="fa fa-circle text-orange"></i> Away</a>
                                        </li>
                                        <li>
                                            <a href="#"><i class="fa fa-circle text-red"></i> Offline</a>
                                        </li>
                                    </ul>
                                </div>
                                <span class="divider"></span>
                                <a data-toggle="collapse" data-parent="#accordion" href="#chat"><i class="fa fa-chevron-down"></i></a>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                        <div id="chat" class="panel-collapse collapse in">
                            <div>
                                <div class="portlet-body chat-widget" style="overflow-y: auto; width: auto; height: 300px;">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <p class="text-center text-muted small">January 1, 2014 at 12:23 PM</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="media">
                                                <a class="pull-left" href="#">
                                                    <img class="media-object img-circle" src="https://lorempixel.com/30/30/people/1/" alt="">
                                                </a>
                                                <div class="media-body">
                                                    <h4 class="media-heading">
                                                        Jane Smith
                                                        <span class="small pull-right">12:23 PM</span>
                                                    </h4>
                                                    <p>Hi, I wanted to make sure you got the latest product report. Did Roddy get it to you?</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="media">
                                                <a class="pull-left" href="#">
                                                    <img class="media-object img-circle" src="https://lorempixel.com/30/30/people/7/" alt="">
                                                </a>
                                                <div class="media-body">
                                                    <h4 class="media-heading">
                                                        John Smith
                                                        <span class="small pull-right">12:28 PM</span>
                                                    </h4>
                                                    <p>Yeah I did. Everything looks good.</p>
                                                    <p>Did you have an update on purchase order #302?</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="media">
                                                <a class="pull-left" href="#">
                                                    <img class="media-object img-circle" src="https://lorempixel.com/30/30/people/7/" alt="">
                                                </a>
                                                <div class="media-body">
                                                    <h4 class="media-heading">
                                                        Jane Smith
                                                        <span class="small pull-right">12:39 PM</span>
                                                    </h4>
                                                    <p>No not yet, the transaction hasn't cleared yet. I will let you know as soon as everything goes through. Any idea where you want to get lunch today?</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                </div>
                            </div>
                            <div class="portlet-footer">
                                <form role="form">
                                    <div class="form-group">
                                        <textarea class="form-control" placeholder="Enter message..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-default pull-right">Send</button>
                                        <div class="clearfix"></div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.col-md-4 -->
            </div>
        </div>
    </div>


    @*<ul class="list-group">
            <li class="list-group-item">
                <span class="badge">14</span>
                Cras justo odio
            </li>

            @foreach (var user in Model)
            {
                <li class="list-group-item">
                    @user.name
                    <span class="badge">14</span>
                </li>

            }
        </ul>*@
</div>
