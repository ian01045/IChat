@model IEnumerable<IChat.Models.user_master>
@{
    ViewBag.Title = "Index";
}


@section css{
    <style>
        .vcenter {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
}


@section js{
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        var clients = [];
        var chat;
        var username="@ViewBag.user.name";
        $(function () {
            chat = $.connection.chatHub;
            var id =@ViewBag.user.id;
            //var username ="ViewBag.user.name";
            $('#displayname').val(username);
            //显示提示方法
            chat.client.showMessage = function (message) {
                alert(message);
            }
            //注册显示信息的方法
            chat.client.addMessage = function (message, connectionId,ismyself) {

                debugger
                if ($.inArray(connectionId, clients)==-1) {
                    var findbtn_conID="button[connectionId="+connectionId+"]";
                    var friendName= $(findbtn_conID).attr('friendName');
                    showWin(connectionId,friendName);
                }
                if(ismyself)
                {
                    $("#" + connectionId).find("ul").append('<li>'+username+":  "+message+'</li>')
                }
                else
                {
                    var findbtn_conID="button[connectionId="+connectionId+"]";
                    var friendName= $(findbtn_conID).attr('friendName');
                    $("#" + connectionId).find("ul").append('<li>'+friendName+"  "+message+'</li>')
                }
            }
            //注册显示所有用户的方法
            chat.client.getUsers = function (data) {
                if (data) {
                    //var json = $.parseJSON(data);

                    //console.info(json);
                    //$("#users").html(" ");
                    //for (var i = 0; i < json.length; i++) {
                    //    var html = '<li>用户名:' + json[i].Name + '<button friendName="'+json[i].Name+'" connectionId="' + json[i].ConnectionID + '" onclick="userChat(this)">聊天</button>';
                    //    $("#users").append(html);
                    //}
                    //console.log(data);
                    var usersList=$('#userList').html("");
                    var documentFrag = $(document.createDocumentFragment());
                    for(var i=0 ;i<data.length;i++)
                    {
                        //console.log(data[i])
                        if(data[i].name==username)continue;//如果是自己就跳過這輪迴圈
                        var user= $("<a></a>").attr({"class":"list-group-item alert alert-success","id":data[i].id,"connectionId":data[i].ConnectionId}).text(data[i].name);
                        user.append('<input type="button" value="私聊" class="btn btn-primary btn-sm pull-right chat_btn" />')
                        if(data[i].IsOnline==true)
                        {
                            user.append('<img src="../../Media/green_dot_2.png" class="pull-right vcenter"/>')
                        }
                        documentFrag.append(user);
                    }
                    usersList.append(documentFrag);
                }
            }
            //注册显示推出聊天提示的方法
            chat.client.exitUser = function (data)
            {
                alert(data);
            }
            //注册显示个人信息的方法
            chat.client.showId = function (data)
            {
                $("#conId").html(data);
                clients.push(data);
            }

            $.connection.hub.start().done(function () {
                var connId = $.connection.hub.id;
                $('#connId').text(connId);
                chat.server.getName(username);
            });
        });

        //开始聊天
        function userChat(obj)
        {
            var connectionId = $(obj).attr('connectionId');
            var friendName = $(obj).attr('friendName');
            showWin(connectionId,friendName);
        }
        function  showWin(connectionId,friendName)
        {
            //var connectionId = $(obj).attr('connectionId');
            clients.push(connectionId);
            var html = '<div style="float:left;margin-left:30px;border:double" id="' + connectionId + '" connectionId="' + connectionId + '">' + friendName + '私聊:<button onclick="exitChat(this)">離開</button><ul id=chat_area></ul><input type="text" /> <button onclick="sendMessage(this)">送出</button></div>';
            $("#userBox").append(html);
        }

        function exitChat(btnObj)
        {
            debugger
            //  var connectionId = $(btnObj).parent().attr("connectionId");
            $(btnObj).parent().remove();
            //chat.server.exitChat(connectionId);
        }
        //发送消息
        function sendMessage(data)
        {
            var message = $(data).prev().val();
            var  userObj = $(data).parent();
            //var username = $("#userName").html();
            //message = username + ":" + message;
            console.info($(userObj).attr("connectionId"));
            var targetConnectionId = $(userObj).attr("connectionId");
            chat.server.sendMessage(targetConnectionId, message);
            $(data).prev().val("");
        }

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        //按下私聊開始聊天
        $('.chat_btn').click(function(){
            //var connectionId = $(obj).attr('connectionId');
            //var friendName = $(obj).attr('friendName');
            //showWin(connectionId,friendName);
            var connectionId=$(this).parent.attr('connectionId').val();
            var friendName=$(this).parent.text();
            showWin(connectionId,friendName);
        })
    </script>

}
<h2>聊天室首頁</h2>
<h3>@ViewBag.user.name 你好~</h3>
@*<div>名称：<p id="userName"></p></div>*@
@*<div>ConnectionID:<p id="conId"></p></div>*@
<input type="hidden" id="conId" />
<div style="width:25%;border:1px solid #ff0000">
    <div>在線用戶</div>
    <ul id="users"></ul>
    <div id="userBox"></div>
</div>
<div class="container">
    @*<a href="@Url.Action("Index","Home")" class="btn btn-primary"><span class="glyphicon glyphicon-plus"></span></a>*@
    <div class="row">
        <table class="table table-bordered table-hover col-lg-12">
            <thead>
                <tr>
                    <th>個人編號</th>
                    <th>個人名稱</th>
                    <th>個人電話</th>
                    <th>個人email</th>
                    <th>編輯</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@ViewBag.user.id</td>
                    <td>@ViewBag.user.name</td>
                    <td>@ViewBag.user.phone</td>
                    <td>@ViewBag.user.email</td>
                    <td>
                        <a href="@Url.Action("Edit", "Home", new { id = ViewBag.user.id })" class="btn btn-primary"><span class="glyphicon glyphicon-pencil"></span></a>
                    </td>
                    @*<td>
                            <a href="@Url.Action("Index", "Home")" class="btn btn-danger"><span class="glyphicon glyphicon-trash"></span></a>
                        </td>*@
                </tr>
            </tbody>
        </table>
        <h3>在線朋友列表</h3>
        <div class="list-group col-lg-6" id="userList">
            @foreach (var user in Model)
            {
                if (user.id != ViewBag.user.id)
                {
                    <a class="list-group-item alert alert-success" id="@user.id" name="@user.name">
                        @user.name
                        <input type="button" value="私聊" class="btn btn-primary btn-sm" />
                        @if (user.IsOnline != null && user.IsOnline == true)
                        {
                            <img src="~/Media/green_dot_2.png" class="pull-right vcenter " />
                        }
                    </a>
                }
            }
        </div>
    </div>
</div>
